<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Docker &middot; Yu's Tech 블로그
    
  </title>

  <!-- BOOTSTRAP -->
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

  <!-- CODE BLOCK FONT -->
  <link href="http://cdn.jsdelivr.net/gh/joungkyun/font-d2coding/d2coding.css" rel="stylesheet" type="text/css">

  <!-- SCROLLSPY-->
  <script src="https://unpkg.com/scrollnav@3.0.2/dist/scrollnav.min.umd.js"></script>
  <link rel="stylesheet" href="/assets/css/style.css">

  
  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

    <!-- syntax.css -->
  <link rel="stylesheet" href="/assets/css/syntax.css">

  <!-- font -->
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic&display=swap" rel="stylesheet">
  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <!-- Google Analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-146052-15', 'getpoole.com');
    ga('send', 'pageview');
  </script>

</head>

  <!--
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
-->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
    }
  });
</script>
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>



  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>You will never know until you try.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home <small class="text-info">21</small></a>

    

    <!-- 
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
    
      
    
      
    
      
        
          <a class="sidebar-nav-item" href="/category/Algorithm/index.html">Algorithm</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/category/Deep%20learning/index.html">Deep learning</a>
        
      
    
      
        
          <a class="sidebar-nav-item active" href="/category/Docker/index.html">Docker</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/category/HPC/index.html">HPC</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/category/Lecture/index.html">Lecture</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/category/Mongodb/index.html">Mongodb</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/category/OpenCL/index.html">OpenCL</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/category/Operating%20system/index.html">Operating system</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/category/Python/index.html">Python</a>
        
      
    
      
        
          <a class="sidebar-nav-item" href="/category/Spark/index.html">Spark</a>
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
    
 -->
    
      <a class = "sidebar-nav-item " href="/category/Python/index.html">Python <small class="text-info">3</small></a>  
    <!--<a class="sidebar-nav-item" href="/category/Python/index.html">Python</a>  <small class="text-muted">3</small>-->
    
      <a class = "sidebar-nav-item " href="/category/Mongodb/index.html">Mongodb <small class="text-info">1</small></a>  
    <!--<a class="sidebar-nav-item" href="/category/Mongodb/index.html">Mongodb</a>  <small class="text-muted">1</small>-->
    
      <a class = "sidebar-nav-item " href="/category/Spark/index.html">Spark <small class="text-info">1</small></a>  
    <!--<a class="sidebar-nav-item" href="/category/Spark/index.html">Spark</a>  <small class="text-muted">1</small>-->
    
      <a class = "sidebar-nav-item " href="/category/Algorithm/index.html">Algorithm <small class="text-info">4</small></a>  
    <!--<a class="sidebar-nav-item" href="/category/Algorithm/index.html">Algorithm</a>  <small class="text-muted">4</small>-->
    
      <a class = "sidebar-nav-item " href="/category/Deep learning/index.html">Deep learning <small class="text-info">1</small></a>  
    <!--<a class="sidebar-nav-item" href="/category/Deep learning/index.html">Deep learning</a>  <small class="text-muted">1</small>-->
    
      <a class = "sidebar-nav-item " href="/category/OpenCL/index.html">OpenCL <small class="text-info">1</small></a>  
    <!--<a class="sidebar-nav-item" href="/category/OpenCL/index.html">OpenCL</a>  <small class="text-muted">1</small>-->
    
      <a class = "sidebar-nav-item " href="/category/Operating system/index.html">Operating system <small class="text-info">1</small></a>  
    <!--<a class="sidebar-nav-item" href="/category/Operating system/index.html">Operating system</a>  <small class="text-muted">1</small>-->
    
      <a class = "sidebar-nav-item " href="/category/Lecture/index.html">Lecture <small class="text-info">7</small></a>  
    <!--<a class="sidebar-nav-item" href="/category/Lecture/index.html">Lecture</a>  <small class="text-muted">7</small>-->
    
      <a class = "sidebar-nav-item " href="/category/HPC/index.html">HPC <small class="text-info">1</small></a>  
    <!--<a class="sidebar-nav-item" href="/category/HPC/index.html">HPC</a>  <small class="text-muted">1</small>-->
    
      <a class = "sidebar-nav-item  active" href="/category/Docker/index.html">Docker <small class="text-info">1</small></a>  
    <!--<a class="sidebar-nav-item" href="/category/Docker/index.html">Docker</a>  <small class="text-muted">1</small>-->
    
    
<!--
    <a class="sidebar-nav-item" href="https://github.com/Yujaeseo/Yujaeseo.github.io.git/archive/v1.0.0.zip">Download</a>
    <a class="sidebar-nav-item" href="https://github.com/Yujaeseo/Yujaeseo.github.io.git">GitHub project</a>
    <span class="sidebar-nav-item">Currently v1.0.0</span>
-->
  </nav>
<!--
  <div class="sidebar-item">
    <p>
      &copy; 2022. All rights reserved.
    </p>
  </div>
-->
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Yu's Tech 블로그</a>
            <small>프로그래밍 이야기</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
    
    
      <div class="index-post">
            <h1 class="post-title">
            <a href="/docker/2022/09/04/Docker-deep-learning-dev-environment/">
                Docker를 이용한 deep learning 개발 환경 구축
            </a>
            </h1>

            <span class="post-date">04 Sep 2022</span>
            
            
              
                <span class="badge badge-dark">MLops</span>
              
            
              
                <span class="badge badge-dark">Deep learning</span>
              
            
              
                <span class="badge badge-dark">Machine learning</span>
              
            
              
                <span class="badge badge-dark">Docker</span>
              
            
            
            <!-- <hr />

<p><br /><br /><br /></p>

<h2 id="개요"><strong>개요</strong></h2>

<p>이번 글은 딥러닝을 위한 개발 환경을 <code class="language-plaintext highlighter-rouge">docker</code>를 이용해 구축하는 일부 과정을 담았다. <code class="language-plaintext highlighter-rouge">Ubuntu</code>에 딥러닝 개발에 많이 사용하는 <code class="language-plaintext highlighter-rouge">anaconda</code> 프레임워크를 포함하는 개발 환경을 구축하기 위한 dockerfile을 작성하고, 이를 토대로 docker image build, container 실행까지 해본다.</p>

<p><br /><br /></p>

<h2 id="dockerfile-작성"><strong>Dockerfile 작성</strong></h2>

<ul>
  <li>
    <p><strong>Dockerfile</strong></p>

    <p><code class="language-plaintext highlighter-rouge">Dockerfile</code>은  docker image를 만들기 위한 command들이 모여있는 text 파일이다. Dockerfile의 파일 이름은 별도의 확장자 없이 <code class="language-plaintext highlighter-rouge">Dockerfile</code>이라고 설정하는 것이 권장된다. 따라서, 프로젝트 디렉토리에 파일을 생성한 후 아래의 내용을 참고해서 dockerfile을 작성하면된다. 파일을 작성한 후에는 해당 파일을 build하여 image를 생성하고, 이를 실행하면 container를 생성한다.</p>
  </li>
  <li>
    <p><strong>Base image 설정</strong></p>

    <div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> ubuntu:18.04</span>
</code></pre></div>    </div>

    <p>Image를 만들때는 작업의 효율성을 위해 보통 다른 사람들이 많들어 놓은 image를 기반으로 그 위에 하나씩 layer를 쌓게된다. 만약 이미지의 모든 부분을 스스로 만든다고 하면 모든 dependecy 및 setting을 고려하여 작업을 해야하기 때문에 이미지 제작에 소요되는 시간이 무척 오래 걸릴 것이다.  AI를 전공하는 사람들이 가장 많이 사용하는 linux 운영체제 중 하나가 <code class="language-plaintext highlighter-rouge">ubuntu</code>이기 때문에 <code class="language-plaintext highlighter-rouge">ubuntu</code> 이미지를 base image로 설정한다. 이때 Base image는 <code class="language-plaintext highlighter-rouge">FROM</code> 명령어를 통해 설정할 수 있다.  <code class="language-plaintext highlighter-rouge">FROM</code> 뒤에 원하는 이미지와 태그명을 쓰면 된다. 이후에 base image 위에 anaconda를 구동하기 위한 환경 설정을 하고 anaconda를 install한다.</p>
  </li>
  <li>
    <p><strong>Shell 설정</strong></p>

    <div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SHELL</span><span class="s"> ["/bin/bash", "--login", "-c" , "-o", "pipefail"]</span>
</code></pre></div>    </div>

    <p>Image build 시에 사용할 shell을 변경하려면 <code class="language-plaintext highlighter-rouge">SHELL</code> 명령어를 사용해야 한다. 사용 형태는 <code class="language-plaintext highlighter-rouge">SHELL ["executable", "parameters"]</code>으로 해당 명령어는 기존에 설정된 shell을 override 할수 있게 해준다. <code class="language-plaintext highlighter-rouge">SHELL</code> 명령어는 파일 내에서 여러번 나올 수 있는데, 이때는 나중에 나온 설정이 이전 설정을 override하게 된다.</p>

    <p>Linux의 default shell은 <code class="language-plaintext highlighter-rouge">/bin/sh</code>이지만, 현재 anaconda는 <code class="language-plaintext highlighter-rouge">/bin/sh</code>를 지원하지 않으므로, ubuntu에서 일반적으로 많이 사용하는 <code class="language-plaintext highlighter-rouge">bash</code>를 default로 세팅해준다. 이때  <code class="language-plaintext highlighter-rouge">--login</code> 옵션으로  login shell을 실행하도록 설정한다.</p>

    <p><code class="language-plaintext highlighter-rouge">-c</code>  인자는 string에서 command를 읽도록 설정하는 옵션이다. <code class="language-plaintext highlighter-rouge">-o pipefail</code> 옵션은 이후에 user 설정에서 실행할 pipeline을 위해 넣어준 옵션으로서, <code class="language-plaintext highlighter-rouge">|</code>를 이용해서 연결된 command를 실행할 때 도중에 error가 발생하면 이를 시스템과 사용자가 발견할 수 있도록해준다. 해당 설정을 사용하지 않으면, pipeline 실행의 return 값이 마지막에 실행된 command에서 나오게 된다. 따라서 마지막 command만 정상적으로 수행된다면 이전에 발생한 error를 발견할 수 없다. 반면에 해당 옵션을 사용하면, return 값이 오른쪽으로 전달되어 가장 오른쪽에서 발생한 error가 pipeline 실행 결과 값으로 나오게되고 해당 return 값을 통해 오류 발생 여부를 판단할 수 있게된다.</p>
  </li>
  <li>
    <p><strong>apt-get 업데이트 및 wget 설치</strong></p>

    <div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">RUN  </span>apt-get update <span class="se">\
</span><span class="o">&amp;&amp;</span> apt-get <span class="nb">install</span> <span class="nt">-y</span> wget <span class="nb">sudo</span> <span class="se">\
</span><span class="o">&amp;&amp;</span> <span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/apt/lists/<span class="k">*</span>
</code></pre></div>    </div>

    <p>Anaconda installer를 서버에 설치해야 되는데, 이때 ubuntu에서 웹서버에서 프로그램을 다운로드 할때  주로 사용되고 있는<code class="language-plaintext highlighter-rouge">wget</code>를 이용하려고 한다. 이를 위해서 패키지 관리 툴인 <code class="language-plaintext highlighter-rouge">apt(Advanced Package Tool)</code>가 install, upgrade, cleaning를 위해 제공하는 <code class="language-plaintext highlighter-rouge">apt-get</code>을 업데이트 한 후에 <code class="language-plaintext highlighter-rouge">wget</code>을 install 한다. 필요한 패키지를 설치한 후에는 <code class="language-plaintext highlighter-rouge">apt</code>가 관리하는 패키지에 대한 정보들이 저장되어 있는 저장소(<code class="language-plaintext highlighter-rouge">/var/lib/apt/lists</code>)를 비워 이미지 사이즈를 줄인다.  추가적으로 프로그램 실행 권한을 관리하는 명령어인 <code class="language-plaintext highlighter-rouge">sudo</code>도 설치한다.</p>
  </li>
  <li>
    <p><strong>Non-root user 설정</strong></p>

    <p>기본적으로 docker container는 root 권한을 갖고 실행되도록 세팅이 되어있다. 이때 container 안에서 실행되는 application들도 root 권한을 갖게 된다. 이때 만약 해커가 호스트에서 실행되는 container 및 application을 해킹하면 호스트 시스템의 root 권한을 얻어 여러 resource에 접근할 수 있게 되어 보안상 큰 문제가 발생할 수 있게된다. 따라서, 일반적으로 container를 non-root user로 실행하여 발생할 수 있는 보안상의 문제를 완화할 필요가 있다.</p>

    <p>하지만, 현재 생성하고자 하는 docker container는 딥러닝 개발을 위해 개인적으로 사용하려고 하는 목적이기 때문에 user를 생성하되, sudo 권한을 부여하여 컨테이너 설정 및 이용을 편하게 할수 있도록 한다.</p>

    <div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ARG</span><span class="s"> username=ubuntu</span>
<span class="k">ARG</span><span class="s"> uid=11</span>
<span class="k">ARG</span><span class="s"> upwd=123</span>
<span class="k">ENV</span><span class="s"> USER=$username UID=$uid UPWD=$upwd HOME=/home/$username</span>
<span class="k">RUN </span>useradd <span class="nv">$USER</span> <span class="nt">-rm</span> <span class="nt">-d</span> <span class="nv">$HOME</span> <span class="nt">-G</span> <span class="nb">sudo</span> <span class="nt">-s</span> /bin/bash <span class="nt">-u</span> <span class="nv">$UID</span>
<span class="k">RUN </span><span class="nb">echo</span> <span class="nv">$USER</span>:<span class="nv">$UPWD</span> | chpasswd
<span class="k">RUN </span><span class="nb">echo</span> <span class="s1">'%sudo ALL=(ALL) NOPASSWD:ALL'</span> <span class="o">&gt;&gt;</span> /etc/sudoers
<span class="k">WORKDIR</span><span class="s"> $HOME</span>
</code></pre></div>    </div>

    <p><code class="language-plaintext highlighter-rouge">ARG</code>는 docker image build시에 사용할 수 있는 값들을 설정할 때 쓰이는 값이다.  <code class="language-plaintext highlighter-rouge">ENV</code>와의 차이는 <code class="language-plaintext highlighter-rouge">ARG</code>에서 설정한 값은 image build 시점에서만 사용되지만, <code class="language-plaintext highlighter-rouge">ENV</code>에서 설정한 값은 image build 시 <code class="language-plaintext highlighter-rouge">RUN</code>command와 build 후 container runtime에서 사용될 수 있다는 점이다. 두 명령어를 통해 user 정보와 관련된 값들을 설정하고, 이 값들을 유저를 추가할 수 있는 <code class="language-plaintext highlighter-rouge">useradd</code>  명령어와 함께 사용하여 sudo 권한을 갖는 유저를 생성한다. 이때 <code class="language-plaintext highlighter-rouge">/etc/sudoers</code>에 <code class="language-plaintext highlighter-rouge">'%sudo ALL=(ALL) NOPASSWD:ALL'</code>를 추가하여 계정 password를 치지않고 <code class="language-plaintext highlighter-rouge">sudo</code> 명령어를 사용할 수 있게 설정한다.</p>
  </li>
  <li>
    <p><strong>Anaconda 설치</strong></p>

    <div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ENV</span><span class="s"> URL_PREFIX=https://repo.anaconda.com/miniconda \</span>
	INSTALLER_URL=$URL_PREFIX/Miniconda3-latest-Linux-x86_64.sh \
	CONDA_DIR=~/miniconda3
     	
<span class="k">RUN </span>wget <span class="nt">--quiet</span> <span class="nv">$INSTALLER_URL</span> <span class="nt">-O</span> ~/miniconda.sh <span class="o">&amp;&amp;</span><span class="se">\
</span>	<span class="nb">chmod </span>u+x ~/miniconda.sh <span class="o">&amp;&amp;</span> <span class="se">\
</span>	~/miniconda.sh <span class="nt">-b</span> <span class="nt">-p</span> <span class="nv">$CONDA_DIR</span> <span class="o">&amp;&amp;</span><span class="se">\
</span>	<span class="nb">rm</span> ~/miniconda.sh
</code></pre></div>    </div>

    <p>전 과정에서 설치한 <code class="language-plaintext highlighter-rouge">wget</code>으로 <code class="language-plaintext highlighter-rouge">miniconda</code>를 설치한다. <code class="language-plaintext highlighter-rouge">miniconda</code>는 <code class="language-plaintext highlighter-rouge">anaconda</code>와 다르게 최소한의 패키지만을 포함하는 압축된 버전이다. 기본적인 요구 사항들만을 포함하고 있기 때문에 원하는 패키지를 그때그때 다운받아야하지만, 가볍고 빠르다는 장점이 있다.</p>
  </li>
  <li>
    <p><strong>Conda 기본 설정</strong></p>

    <div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ENV</span><span class="s"> PATH=$CONDA_DIR/bin:$PATH</span>
<span class="k">RUN </span>conda init bash
</code></pre></div>    </div>

    <p>Bash에서 <code class="language-plaintext highlighter-rouge">conda</code> 명령어 사용을 위한 환경 변수 설정과 <code class="language-plaintext highlighter-rouge">conda init bash</code> 를 통해 bash에서 <code class="language-plaintext highlighter-rouge">conda activate</code>  명령어를 비롯하여 conda에서 제공하는 다양한 기능을 사용할 수 있도록 설정해준다.</p>
  </li>
  <li>
    <p><strong>Project directory 설정</strong></p>

    <div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ENV</span><span class="s"> PROJECT_DIR ~/app</span>
<span class="k">RUN </span><span class="nb">mkdir</span> <span class="nv">$PROJECT_DIR</span>
<span class="k">WORKDIR</span><span class="s"> $PROJECT_DIR</span>
</code></pre></div>    </div>

    <p>진행하고자하는 프로젝트에 필요한 소스코드, 소프트웨어를 비롯한 파일을 모아둘 폴더(<code class="language-plaintext highlighter-rouge">app</code>)를 home directory(<code class="language-plaintext highlighter-rouge">~/</code>)에 생성한다. 프로젝트 별로 필요한 여러 파일들을 하나의 directory에 저장하고 관리하면 깔끔하고 관리의 용이성도 커진다.</p>
  </li>
  <li>
    <p><strong>Conda environment 생성</strong></p>

    <p>Conda environment를 이전 과정에서 만든 directory에 생성한다. 이때 <code class="language-plaintext highlighter-rouge">conda create</code>명령어를 사용하며 <code class="language-plaintext highlighter-rouge">-p</code>  인자를 통해 가상환경을 생성할 폴더의 path(<code class="language-plaintext highlighter-rouge">$ENV_PREFIX/test</code>)를 지정한다. 가상환경이 생성은 됐지만, 가상환경의 이름은 지정되지 않은 상황이다. 따라서 가상환경을 지칭할 때 full path를 입력해야된다. 하지만 가상환경을 활성화하는 것을 비롯하여 가상환경을 이용할 때 이를 지칭하는 이름이 있어야 명령어가 짧아지고 관리하기 편해진다.  <code class="language-plaintext highlighter-rouge">conda config --append</code> 명령어에 가상환경 폴더(<code class="language-plaintext highlighter-rouge">$ENV_PREFIX/test</code>)의 parent directory (<code class="language-plaintext highlighter-rouge">$ENV_PREFIX</code>)를 넘겨주면, conda configuration 파일인 <code class="language-plaintext highlighter-rouge">.condarc</code> 에 가상환경 directory를 추가할 수 있으며, 이를 통해가상환경을 지칭하는 이름을 설정할 수 있다.</p>

    <p>가상환경 생성, 이름 세팅을 별도의 명령어로 나누어서 진행했지만, <code class="language-plaintext highlighter-rouge">conda create</code> 에서 <code class="language-plaintext highlighter-rouge">-n</code> 인자를 통해 가상환경 생성시에 이름을 설정할 수 있다. 다만, 구체적인 이유는 모르겠지만 가상환경 폴더의 path를 설정하는 인자(<code class="language-plaintext highlighter-rouge">-p</code>)와 <code class="language-plaintext highlighter-rouge">-n</code>를 함께 쓸 수 없기 때문에 차선책으로 가상환경을 지정된 위치에 생성, 이름을 지정하는 두번의 step으로 나누어서 진행하였다.</p>

    <div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ENV</span><span class="s"> ENV_PREFIX $PROJECT_DIR/env</span>
<span class="k">RUN </span>conda update <span class="nt">-n</span> base <span class="nt">-c</span> defaults conda <span class="o">&amp;&amp;</span> <span class="se">\
</span>	conda create <span class="nt">-p</span> <span class="nv">$ENV_PREFIX</span>/test <span class="o">&amp;&amp;</span> <span class="se">\
</span>	conda config <span class="nt">--append</span> envs_dirs <span class="nv">$ENV_PREFIX</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span>	conda clean <span class="nt">--all</span> <span class="nt">--yes</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>Container 실행 명령 정의</strong></p>

    <div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ENTRYPOINT</span><span class="s"> ["/bin/bash", "-l", "-i"]</span>
<span class="k">USER</span><span class="s"> $USER</span>
</code></pre></div>    </div>

    <p><code class="language-plaintext highlighter-rouge">Entrypoint</code> 명령어를 이용하여 컨테이너 시작시 실행할 명령을 지정할 수 있다.  <code class="language-plaintext highlighter-rouge">bash</code>를 login shell로 실행하도록 설정하며,  <code class="language-plaintext highlighter-rouge">USER $USER</code>를 통해 root가 아닌 생성한 user로 컨테이너를 사용할수 있도록 세팅한다.</p>
  </li>
</ul>

<p><br /><br /></p>

<h2 id="image-build-및-container-실행"><strong>Image build 및 container 실행</strong></h2>

<ul>
  <li>
    <p><strong>Build image</strong></p>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">docker</span><span class="w"> </span><span class="nx">image</span><span class="w"> </span><span class="nx">build</span><span class="w"> </span><span class="o">.</span><span class="nx">/</span><span class="err">`</span><span class="w">
	</span><span class="nt">--build-arg</span><span class="w"> </span><span class="nf">username</span><span class="o">=</span><span class="nv">$USER</span><span class="w"> </span><span class="err">`</span><span class="w">
	</span><span class="nt">--build-arg</span><span class="w"> </span><span class="nf">uid</span><span class="o">=</span><span class="nv">$UID</span><span class="w"> </span><span class="err">`</span><span class="w">
	</span><span class="nt">--build-arg</span><span class="w"> </span><span class="nf">upwd</span><span class="o">=</span><span class="nv">$UPWD</span><span class="w">
	</span><span class="nt">--tag</span><span class="w"> </span><span class="nv">$IMAGE_NAME</span><span class="p">:</span><span class="nv">$IMAGE_TAG</span><span class="w"> </span><span class="err">`</span><span class="w">
</span></code></pre></div>    </div>

    <p>작성한 Dockerfile을 이용하여 image를 생성하기 위해서는 <code class="language-plaintext highlighter-rouge">build</code> command를 사용한다. Dockerfile이 존재하는 디렉토리 경로를 넘겨주게 되면, 자동으로 Dockerfile을 읽어 image를 생성한다.이때 <code class="language-plaintext highlighter-rouge">--tag</code> 옵션을 통해 이미지 이름과 tag 정보를 추가할 수 있다. <code class="language-plaintext highlighter-rouge">--build-arg</code> 를 이용하면 build 시에 Dockerfile 내의 <code class="language-plaintext highlighter-rouge">ARG</code>의 대응되는 key 값에 사용자가 넣은 값을 할당할 수 있게된다.  계정 패스워드와 같은 민감한 정보를 이와 같은 식으로 넘겨주는 것은 피해야하며 docker에서 제공하는  <code class="language-plaintext highlighter-rouge">secret</code>과 같은 기능을 사용하여 정보를 넘겨주는 것이 좋다. 하지만 이번 프로젝트의 목적은 개인을 위한 딥러닝 개발 환경을 시험삼아 한번 만들어 보는 것이기 때문에 이와 같은 사항을 고려하지 않기로 한다. 참고로 필자는 window powershell에서 프로젝트를 진행하기 때문에, backslash(\)가 아닌 backtick(`)을 사용하여 command의 행을 나눴다.</p>
  </li>
  <li>
    <p><strong>Run container</strong></p>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">docker</span><span class="w"> </span><span class="nx">container</span><span class="w"> </span><span class="nx">run</span><span class="w"> </span><span class="nt">-it</span><span class="w"> </span><span class="nv">$IMAGE_NAME</span><span class="p">:</span><span class="nv">$IMAGE_TAG</span><span class="w">
</span></code></pre></div>    </div>

    <p><code class="language-plaintext highlighter-rouge">run</code> 명령어와 이미지 이름 및 태그 정보를 통해 생성한 docker 이미지를 container로 만들 수 있다. <code class="language-plaintext highlighter-rouge">-it</code> 옵션은 <code class="language-plaintext highlighter-rouge">--interactive</code> ,<code class="language-plaintext highlighter-rouge">--tty</code>가 결합된 것으로, 컨테이너가 바로 종료되지 않고 현재 작업하고 있는 terminal에서 CLI를 통해 컨테이너를 조작할 수 있도록 만들어준다.</p>

    <p><br /><br /></p>
  </li>
</ul>

<h2 id="결과"><strong>결과</strong></h2>

<p>container를 실행하면 <code class="language-plaintext highlighter-rouge">anaconda</code>가 설치된 <code class="language-plaintext highlighter-rouge">ubuntu</code> 환경에 접속할 수 있게 되고, <code class="language-plaintext highlighter-rouge">conda env list</code> 와 <code class="language-plaintext highlighter-rouge">conda activate</code>를 통해 원하는 가상환경이 제대로 설치됐는지 확인하고 실행해볼 수 있다.</p>

<p><img src="/assets/img/Lecture/Introduction to Model Serving/Introduction to Model Serving Infrastructure/image-20220906162127088.png" alt="image-20220906162127088" /></p>
 -->
            <div class="text-muted post-excerpt">Ubuntu, anaconda 기반 딥러닝 개발 환경을 docker를 이용해서 직접 구축해본다.</div>
        </div>
        <!-- <div class="post">
          <h1 class="post-title">
          <a href="/docker/2022/09/04/Docker-deep-learning-dev-environment/">
              Docker를 이용한 deep learning 개발 환경 구축
          </a>
          </h1>

          <span class="post-date">04 Sep 2022</span>
          
          
            
              <span class="badge badge-dark">MLops</span>
            
          
            
              <span class="badge badge-dark">Deep learning</span>
            
          
            
              <span class="badge badge-dark">Machine learning</span>
            
          
            
              <span class="badge badge-dark">Docker</span>
            
          
          
          <hr />

<p><br /><br /><br /></p>

<h2 id="개요"><strong>개요</strong></h2>

<p>이번 글은 딥러닝을 위한 개발 환경을 <code class="language-plaintext highlighter-rouge">docker</code>를 이용해 구축하는 일부 과정을 담았다. <code class="language-plaintext highlighter-rouge">Ubuntu</code>에 딥러닝 개발에 많이 사용하는 <code class="language-plaintext highlighter-rouge">anaconda</code> 프레임워크를 포함하는 개발 환경을 구축하기 위한 dockerfile을 작성하고, 이를 토대로 docker image build, container 실행까지 해본다.</p>

<p><br /><br /></p>

<h2 id="dockerfile-작성"><strong>Dockerfile 작성</strong></h2>

<ul>
  <li>
    <p><strong>Dockerfile</strong></p>

    <p><code class="language-plaintext highlighter-rouge">Dockerfile</code>은  docker image를 만들기 위한 command들이 모여있는 text 파일이다. Dockerfile의 파일 이름은 별도의 확장자 없이 <code class="language-plaintext highlighter-rouge">Dockerfile</code>이라고 설정하는 것이 권장된다. 따라서, 프로젝트 디렉토리에 파일을 생성한 후 아래의 내용을 참고해서 dockerfile을 작성하면된다. 파일을 작성한 후에는 해당 파일을 build하여 image를 생성하고, 이를 실행하면 container를 생성한다.</p>
  </li>
  <li>
    <p><strong>Base image 설정</strong></p>

    <div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> ubuntu:18.04</span>
</code></pre></div>    </div>

    <p>Image를 만들때는 작업의 효율성을 위해 보통 다른 사람들이 많들어 놓은 image를 기반으로 그 위에 하나씩 layer를 쌓게된다. 만약 이미지의 모든 부분을 스스로 만든다고 하면 모든 dependecy 및 setting을 고려하여 작업을 해야하기 때문에 이미지 제작에 소요되는 시간이 무척 오래 걸릴 것이다.  AI를 전공하는 사람들이 가장 많이 사용하는 linux 운영체제 중 하나가 <code class="language-plaintext highlighter-rouge">ubuntu</code>이기 때문에 <code class="language-plaintext highlighter-rouge">ubuntu</code> 이미지를 base image로 설정한다. 이때 Base image는 <code class="language-plaintext highlighter-rouge">FROM</code> 명령어를 통해 설정할 수 있다.  <code class="language-plaintext highlighter-rouge">FROM</code> 뒤에 원하는 이미지와 태그명을 쓰면 된다. 이후에 base image 위에 anaconda를 구동하기 위한 환경 설정을 하고 anaconda를 install한다.</p>
  </li>
  <li>
    <p><strong>Shell 설정</strong></p>

    <div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SHELL</span><span class="s"> ["/bin/bash", "--login", "-c" , "-o", "pipefail"]</span>
</code></pre></div>    </div>

    <p>Image build 시에 사용할 shell을 변경하려면 <code class="language-plaintext highlighter-rouge">SHELL</code> 명령어를 사용해야 한다. 사용 형태는 <code class="language-plaintext highlighter-rouge">SHELL ["executable", "parameters"]</code>으로 해당 명령어는 기존에 설정된 shell을 override 할수 있게 해준다. <code class="language-plaintext highlighter-rouge">SHELL</code> 명령어는 파일 내에서 여러번 나올 수 있는데, 이때는 나중에 나온 설정이 이전 설정을 override하게 된다.</p>

    <p>Linux의 default shell은 <code class="language-plaintext highlighter-rouge">/bin/sh</code>이지만, 현재 anaconda는 <code class="language-plaintext highlighter-rouge">/bin/sh</code>를 지원하지 않으므로, ubuntu에서 일반적으로 많이 사용하는 <code class="language-plaintext highlighter-rouge">bash</code>를 default로 세팅해준다. 이때  <code class="language-plaintext highlighter-rouge">--login</code> 옵션으로  login shell을 실행하도록 설정한다.</p>

    <p><code class="language-plaintext highlighter-rouge">-c</code>  인자는 string에서 command를 읽도록 설정하는 옵션이다. <code class="language-plaintext highlighter-rouge">-o pipefail</code> 옵션은 이후에 user 설정에서 실행할 pipeline을 위해 넣어준 옵션으로서, <code class="language-plaintext highlighter-rouge">|</code>를 이용해서 연결된 command를 실행할 때 도중에 error가 발생하면 이를 시스템과 사용자가 발견할 수 있도록해준다. 해당 설정을 사용하지 않으면, pipeline 실행의 return 값이 마지막에 실행된 command에서 나오게 된다. 따라서 마지막 command만 정상적으로 수행된다면 이전에 발생한 error를 발견할 수 없다. 반면에 해당 옵션을 사용하면, return 값이 오른쪽으로 전달되어 가장 오른쪽에서 발생한 error가 pipeline 실행 결과 값으로 나오게되고 해당 return 값을 통해 오류 발생 여부를 판단할 수 있게된다.</p>
  </li>
  <li>
    <p><strong>apt-get 업데이트 및 wget 설치</strong></p>

    <div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">RUN  </span>apt-get update <span class="se">\
</span><span class="o">&amp;&amp;</span> apt-get <span class="nb">install</span> <span class="nt">-y</span> wget <span class="nb">sudo</span> <span class="se">\
</span><span class="o">&amp;&amp;</span> <span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/apt/lists/<span class="k">*</span>
</code></pre></div>    </div>

    <p>Anaconda installer를 서버에 설치해야 되는데, 이때 ubuntu에서 웹서버에서 프로그램을 다운로드 할때  주로 사용되고 있는<code class="language-plaintext highlighter-rouge">wget</code>를 이용하려고 한다. 이를 위해서 패키지 관리 툴인 <code class="language-plaintext highlighter-rouge">apt(Advanced Package Tool)</code>가 install, upgrade, cleaning를 위해 제공하는 <code class="language-plaintext highlighter-rouge">apt-get</code>을 업데이트 한 후에 <code class="language-plaintext highlighter-rouge">wget</code>을 install 한다. 필요한 패키지를 설치한 후에는 <code class="language-plaintext highlighter-rouge">apt</code>가 관리하는 패키지에 대한 정보들이 저장되어 있는 저장소(<code class="language-plaintext highlighter-rouge">/var/lib/apt/lists</code>)를 비워 이미지 사이즈를 줄인다.  추가적으로 프로그램 실행 권한을 관리하는 명령어인 <code class="language-plaintext highlighter-rouge">sudo</code>도 설치한다.</p>
  </li>
  <li>
    <p><strong>Non-root user 설정</strong></p>

    <p>기본적으로 docker container는 root 권한을 갖고 실행되도록 세팅이 되어있다. 이때 container 안에서 실행되는 application들도 root 권한을 갖게 된다. 이때 만약 해커가 호스트에서 실행되는 container 및 application을 해킹하면 호스트 시스템의 root 권한을 얻어 여러 resource에 접근할 수 있게 되어 보안상 큰 문제가 발생할 수 있게된다. 따라서, 일반적으로 container를 non-root user로 실행하여 발생할 수 있는 보안상의 문제를 완화할 필요가 있다.</p>

    <p>하지만, 현재 생성하고자 하는 docker container는 딥러닝 개발을 위해 개인적으로 사용하려고 하는 목적이기 때문에 user를 생성하되, sudo 권한을 부여하여 컨테이너 설정 및 이용을 편하게 할수 있도록 한다.</p>

    <div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ARG</span><span class="s"> username=ubuntu</span>
<span class="k">ARG</span><span class="s"> uid=11</span>
<span class="k">ARG</span><span class="s"> upwd=123</span>
<span class="k">ENV</span><span class="s"> USER=$username UID=$uid UPWD=$upwd HOME=/home/$username</span>
<span class="k">RUN </span>useradd <span class="nv">$USER</span> <span class="nt">-rm</span> <span class="nt">-d</span> <span class="nv">$HOME</span> <span class="nt">-G</span> <span class="nb">sudo</span> <span class="nt">-s</span> /bin/bash <span class="nt">-u</span> <span class="nv">$UID</span>
<span class="k">RUN </span><span class="nb">echo</span> <span class="nv">$USER</span>:<span class="nv">$UPWD</span> | chpasswd
<span class="k">RUN </span><span class="nb">echo</span> <span class="s1">'%sudo ALL=(ALL) NOPASSWD:ALL'</span> <span class="o">&gt;&gt;</span> /etc/sudoers
<span class="k">WORKDIR</span><span class="s"> $HOME</span>
</code></pre></div>    </div>

    <p><code class="language-plaintext highlighter-rouge">ARG</code>는 docker image build시에 사용할 수 있는 값들을 설정할 때 쓰이는 값이다.  <code class="language-plaintext highlighter-rouge">ENV</code>와의 차이는 <code class="language-plaintext highlighter-rouge">ARG</code>에서 설정한 값은 image build 시점에서만 사용되지만, <code class="language-plaintext highlighter-rouge">ENV</code>에서 설정한 값은 image build 시 <code class="language-plaintext highlighter-rouge">RUN</code>command와 build 후 container runtime에서 사용될 수 있다는 점이다. 두 명령어를 통해 user 정보와 관련된 값들을 설정하고, 이 값들을 유저를 추가할 수 있는 <code class="language-plaintext highlighter-rouge">useradd</code>  명령어와 함께 사용하여 sudo 권한을 갖는 유저를 생성한다. 이때 <code class="language-plaintext highlighter-rouge">/etc/sudoers</code>에 <code class="language-plaintext highlighter-rouge">'%sudo ALL=(ALL) NOPASSWD:ALL'</code>를 추가하여 계정 password를 치지않고 <code class="language-plaintext highlighter-rouge">sudo</code> 명령어를 사용할 수 있게 설정한다.</p>
  </li>
  <li>
    <p><strong>Anaconda 설치</strong></p>

    <div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ENV</span><span class="s"> URL_PREFIX=https://repo.anaconda.com/miniconda \</span>
	INSTALLER_URL=$URL_PREFIX/Miniconda3-latest-Linux-x86_64.sh \
	CONDA_DIR=~/miniconda3
     	
<span class="k">RUN </span>wget <span class="nt">--quiet</span> <span class="nv">$INSTALLER_URL</span> <span class="nt">-O</span> ~/miniconda.sh <span class="o">&amp;&amp;</span><span class="se">\
</span>	<span class="nb">chmod </span>u+x ~/miniconda.sh <span class="o">&amp;&amp;</span> <span class="se">\
</span>	~/miniconda.sh <span class="nt">-b</span> <span class="nt">-p</span> <span class="nv">$CONDA_DIR</span> <span class="o">&amp;&amp;</span><span class="se">\
</span>	<span class="nb">rm</span> ~/miniconda.sh
</code></pre></div>    </div>

    <p>전 과정에서 설치한 <code class="language-plaintext highlighter-rouge">wget</code>으로 <code class="language-plaintext highlighter-rouge">miniconda</code>를 설치한다. <code class="language-plaintext highlighter-rouge">miniconda</code>는 <code class="language-plaintext highlighter-rouge">anaconda</code>와 다르게 최소한의 패키지만을 포함하는 압축된 버전이다. 기본적인 요구 사항들만을 포함하고 있기 때문에 원하는 패키지를 그때그때 다운받아야하지만, 가볍고 빠르다는 장점이 있다.</p>
  </li>
  <li>
    <p><strong>Conda 기본 설정</strong></p>

    <div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ENV</span><span class="s"> PATH=$CONDA_DIR/bin:$PATH</span>
<span class="k">RUN </span>conda init bash
</code></pre></div>    </div>

    <p>Bash에서 <code class="language-plaintext highlighter-rouge">conda</code> 명령어 사용을 위한 환경 변수 설정과 <code class="language-plaintext highlighter-rouge">conda init bash</code> 를 통해 bash에서 <code class="language-plaintext highlighter-rouge">conda activate</code>  명령어를 비롯하여 conda에서 제공하는 다양한 기능을 사용할 수 있도록 설정해준다.</p>
  </li>
  <li>
    <p><strong>Project directory 설정</strong></p>

    <div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ENV</span><span class="s"> PROJECT_DIR ~/app</span>
<span class="k">RUN </span><span class="nb">mkdir</span> <span class="nv">$PROJECT_DIR</span>
<span class="k">WORKDIR</span><span class="s"> $PROJECT_DIR</span>
</code></pre></div>    </div>

    <p>진행하고자하는 프로젝트에 필요한 소스코드, 소프트웨어를 비롯한 파일을 모아둘 폴더(<code class="language-plaintext highlighter-rouge">app</code>)를 home directory(<code class="language-plaintext highlighter-rouge">~/</code>)에 생성한다. 프로젝트 별로 필요한 여러 파일들을 하나의 directory에 저장하고 관리하면 깔끔하고 관리의 용이성도 커진다.</p>
  </li>
  <li>
    <p><strong>Conda environment 생성</strong></p>

    <p>Conda environment를 이전 과정에서 만든 directory에 생성한다. 이때 <code class="language-plaintext highlighter-rouge">conda create</code>명령어를 사용하며 <code class="language-plaintext highlighter-rouge">-p</code>  인자를 통해 가상환경을 생성할 폴더의 path(<code class="language-plaintext highlighter-rouge">$ENV_PREFIX/test</code>)를 지정한다. 가상환경이 생성은 됐지만, 가상환경의 이름은 지정되지 않은 상황이다. 따라서 가상환경을 지칭할 때 full path를 입력해야된다. 하지만 가상환경을 활성화하는 것을 비롯하여 가상환경을 이용할 때 이를 지칭하는 이름이 있어야 명령어가 짧아지고 관리하기 편해진다.  <code class="language-plaintext highlighter-rouge">conda config --append</code> 명령어에 가상환경 폴더(<code class="language-plaintext highlighter-rouge">$ENV_PREFIX/test</code>)의 parent directory (<code class="language-plaintext highlighter-rouge">$ENV_PREFIX</code>)를 넘겨주면, conda configuration 파일인 <code class="language-plaintext highlighter-rouge">.condarc</code> 에 가상환경 directory를 추가할 수 있으며, 이를 통해가상환경을 지칭하는 이름을 설정할 수 있다.</p>

    <p>가상환경 생성, 이름 세팅을 별도의 명령어로 나누어서 진행했지만, <code class="language-plaintext highlighter-rouge">conda create</code> 에서 <code class="language-plaintext highlighter-rouge">-n</code> 인자를 통해 가상환경 생성시에 이름을 설정할 수 있다. 다만, 구체적인 이유는 모르겠지만 가상환경 폴더의 path를 설정하는 인자(<code class="language-plaintext highlighter-rouge">-p</code>)와 <code class="language-plaintext highlighter-rouge">-n</code>를 함께 쓸 수 없기 때문에 차선책으로 가상환경을 지정된 위치에 생성, 이름을 지정하는 두번의 step으로 나누어서 진행하였다.</p>

    <div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ENV</span><span class="s"> ENV_PREFIX $PROJECT_DIR/env</span>
<span class="k">RUN </span>conda update <span class="nt">-n</span> base <span class="nt">-c</span> defaults conda <span class="o">&amp;&amp;</span> <span class="se">\
</span>	conda create <span class="nt">-p</span> <span class="nv">$ENV_PREFIX</span>/test <span class="o">&amp;&amp;</span> <span class="se">\
</span>	conda config <span class="nt">--append</span> envs_dirs <span class="nv">$ENV_PREFIX</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span>	conda clean <span class="nt">--all</span> <span class="nt">--yes</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>Container 실행 명령 정의</strong></p>

    <div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ENTRYPOINT</span><span class="s"> ["/bin/bash", "-l", "-i"]</span>
<span class="k">USER</span><span class="s"> $USER</span>
</code></pre></div>    </div>

    <p><code class="language-plaintext highlighter-rouge">Entrypoint</code> 명령어를 이용하여 컨테이너 시작시 실행할 명령을 지정할 수 있다.  <code class="language-plaintext highlighter-rouge">bash</code>를 login shell로 실행하도록 설정하며,  <code class="language-plaintext highlighter-rouge">USER $USER</code>를 통해 root가 아닌 생성한 user로 컨테이너를 사용할수 있도록 세팅한다.</p>
  </li>
</ul>

<p><br /><br /></p>

<h2 id="image-build-및-container-실행"><strong>Image build 및 container 실행</strong></h2>

<ul>
  <li>
    <p><strong>Build image</strong></p>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">docker</span><span class="w"> </span><span class="nx">image</span><span class="w"> </span><span class="nx">build</span><span class="w"> </span><span class="o">.</span><span class="nx">/</span><span class="err">`</span><span class="w">
	</span><span class="nt">--build-arg</span><span class="w"> </span><span class="nf">username</span><span class="o">=</span><span class="nv">$USER</span><span class="w"> </span><span class="err">`</span><span class="w">
	</span><span class="nt">--build-arg</span><span class="w"> </span><span class="nf">uid</span><span class="o">=</span><span class="nv">$UID</span><span class="w"> </span><span class="err">`</span><span class="w">
	</span><span class="nt">--build-arg</span><span class="w"> </span><span class="nf">upwd</span><span class="o">=</span><span class="nv">$UPWD</span><span class="w">
	</span><span class="nt">--tag</span><span class="w"> </span><span class="nv">$IMAGE_NAME</span><span class="p">:</span><span class="nv">$IMAGE_TAG</span><span class="w"> </span><span class="err">`</span><span class="w">
</span></code></pre></div>    </div>

    <p>작성한 Dockerfile을 이용하여 image를 생성하기 위해서는 <code class="language-plaintext highlighter-rouge">build</code> command를 사용한다. Dockerfile이 존재하는 디렉토리 경로를 넘겨주게 되면, 자동으로 Dockerfile을 읽어 image를 생성한다.이때 <code class="language-plaintext highlighter-rouge">--tag</code> 옵션을 통해 이미지 이름과 tag 정보를 추가할 수 있다. <code class="language-plaintext highlighter-rouge">--build-arg</code> 를 이용하면 build 시에 Dockerfile 내의 <code class="language-plaintext highlighter-rouge">ARG</code>의 대응되는 key 값에 사용자가 넣은 값을 할당할 수 있게된다.  계정 패스워드와 같은 민감한 정보를 이와 같은 식으로 넘겨주는 것은 피해야하며 docker에서 제공하는  <code class="language-plaintext highlighter-rouge">secret</code>과 같은 기능을 사용하여 정보를 넘겨주는 것이 좋다. 하지만 이번 프로젝트의 목적은 개인을 위한 딥러닝 개발 환경을 시험삼아 한번 만들어 보는 것이기 때문에 이와 같은 사항을 고려하지 않기로 한다. 참고로 필자는 window powershell에서 프로젝트를 진행하기 때문에, backslash(\)가 아닌 backtick(`)을 사용하여 command의 행을 나눴다.</p>
  </li>
  <li>
    <p><strong>Run container</strong></p>

    <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">docker</span><span class="w"> </span><span class="nx">container</span><span class="w"> </span><span class="nx">run</span><span class="w"> </span><span class="nt">-it</span><span class="w"> </span><span class="nv">$IMAGE_NAME</span><span class="p">:</span><span class="nv">$IMAGE_TAG</span><span class="w">
</span></code></pre></div>    </div>

    <p><code class="language-plaintext highlighter-rouge">run</code> 명령어와 이미지 이름 및 태그 정보를 통해 생성한 docker 이미지를 container로 만들 수 있다. <code class="language-plaintext highlighter-rouge">-it</code> 옵션은 <code class="language-plaintext highlighter-rouge">--interactive</code> ,<code class="language-plaintext highlighter-rouge">--tty</code>가 결합된 것으로, 컨테이너가 바로 종료되지 않고 현재 작업하고 있는 terminal에서 CLI를 통해 컨테이너를 조작할 수 있도록 만들어준다.</p>

    <p><br /><br /></p>
  </li>
</ul>

<h2 id="결과"><strong>결과</strong></h2>

<p>container를 실행하면 <code class="language-plaintext highlighter-rouge">anaconda</code>가 설치된 <code class="language-plaintext highlighter-rouge">ubuntu</code> 환경에 접속할 수 있게 되고, <code class="language-plaintext highlighter-rouge">conda env list</code> 와 <code class="language-plaintext highlighter-rouge">conda activate</code>를 통해 원하는 가상환경이 제대로 설치됐는지 확인하고 실행해볼 수 있다.</p>

<p><img src="/assets/img/Lecture/Introduction to Model Serving/Introduction to Model Serving Infrastructure/image-20220906162127088.png" alt="image-20220906162127088" /></p>

      </div> -->
  

</div>
<div class="pagination">
    
      <span class="pagination-item newer">New</span>
    
  
    
      <span class="pagination-item older">Old</span>
    
  
  </div>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

  </body>
  <script>
    const content = document.querySelector(".main-content");
    
    scrollnav.init(content,{
      debug: false,
      updateHistory: false,
      // easingStyle: 'easeOutQuint',
      sections: ($('.post-content > h1').length>0) ? 'h1' : 'h2',
      subSections: ($('.post-content > h1').length>0) ? 'h2' : 'h3'
    });
    
    var sideNav = function(){
      var mainRect = document.getElementById('main-content').getBoundingClientRect();
      $('nav.scroll-nav').css('left', mainRect.right + 50 + 'px');
    }
    
    sideNav();
    window.addEventListener("resize", sideNav);
    
   

    
    // window.addEventListener('load', (event) => {
    //   console.log('page is fully loaded');
    //   scrollnav.updatePositions();
  
    // });

  </script>
</html>
